name: Issue phase commands
on:
  issue_comment:
    types: [created]
permissions:
  issues: write
jobs:
  commands:
    if: github.event.issue.pull_request == null
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;
            const body = (context.payload.comment.body || "").trim().toLowerCase();

            const phaseOrder = [
              "phase:idea_explore",
              "phase:idea_define",
              "phase:research",
              "phase:poc",
              "phase:design",
              "phase:implement"
            ];
            const validPhases = new Set([...phaseOrder, "phase:frozen"]);
            const phasePrefix = "phase:";

            function currentPhase(issue) {
              const phases = (issue.labels || [])
                .map(l => l.name || "")
                .filter(n => n.startsWith(phasePrefix));
              return phases[0] || null;
            }

            async function setPhase(issue, next) {
              const phases = (issue.labels || [])
                .map(l => l.name || "")
                .filter(n => n.startsWith(phasePrefix));
              for (const p of phases) {
                if (p !== next) {
                  try { await github.rest.issues.removeLabel({ owner, repo, issue_number, name: p }); } catch (e) {}
                }
              }
              const hasNext = (issue.labels || []).some(l => (l.name || "") === next);
              if (!hasNext) {
                await github.rest.issues.addLabels({ owner, repo, issue_number, labels: [next] });
              }
            }

            function nextPhaseOf(curr) {
              if (!curr) return phaseOrder[0];
              if (curr === "phase:frozen") return phaseOrder[0];
              const idx = phaseOrder.indexOf(curr);
              if (idx < 0) return phaseOrder[0];
              if (idx >= phaseOrder.length - 1) return phaseOrder[idx];
              return phaseOrder[idx + 1];
            }

            function guidance(phase) {
              const map = {
                "phase:idea_explore": "ğŸ§  Idea Explore\n\n- ChatGPTã§Explore\n- çµæœè²¼ã‚‹\n- /approve ã§æ¬¡ã¸",
                "phase:idea_define": "ğŸ¯ Idea Define\n\n- æ¡ˆã‚’1ã¤ã«çµã‚‹\n- ã‚¹ã‚³ãƒ¼ãƒ—/æˆåŠŸæ¡ä»¶\n- /approve",
                "phase:research": "ğŸ” Research\n\n- èª¿æŸ»çµæœæ•´ç†\n- PoCæ¡ˆ\n- /approve",
                "phase:poc": "ğŸ§ª PoC\n\n- æœ€å°æ¤œè¨¼\n- å­¦ã³\n- /approve /freeze",
                "phase:design": "ğŸ“ Design\n\n- ä»•æ§˜ã¾ã¨ã‚\n- ã‚¿ã‚¹ã‚¯åˆ†å‰²\n- /approve",
                "phase:implement": "ğŸ›  Implement\n\n- Codexãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ\n- PR/åˆ†å‰²",
                "phase:frozen": "â„ Frozen\n\n- ä¿ç•™ç†ç”±/å†é–‹æ¡ä»¶\n- /phase idea_explore"
              };
              return map[phase] || `Phase: ${phase}`;
            }

            async function comment(msg) {
              await github.rest.issues.createComment({ owner, repo, issue_number, body: msg });
            }

            async function getIssue() {
              const res = await github.rest.issues.get({ owner, repo, issue_number });
              return res.data;
            }

            if (body === "/approve") {
              const issue = await getIssue();
              const curr = currentPhase(issue);
              const next = nextPhaseOf(curr);
              await setPhase(issue, next);
              await comment(`âœ… Phase moved: ${curr || "none"} â†’ ${next}\n\n${guidance(next)}`);
              return;
            }

            if (body === "/freeze") {
              const issue = await getIssue();
              const curr = currentPhase(issue);
              const next = "phase:frozen";
              await setPhase(issue, next);
              await comment(`â„ï¸ Frozen: ${curr || "none"} â†’ ${next}\n\n${guidance(next)}`);
              return;
            }

            if (body.startsWith("/phase")) {
              const issue = await getIssue();
              const parts = body.split(/\s+/).filter(Boolean);
              if (parts.length < 2) {
                await comment("Usage: /phase idea_explore|idea_define|research|poc|design|implement|frozen");
                return;
              }
              let name = parts[1].trim();
              const alias = { idea: "idea_explore", explore: "idea_explore", define: "idea_define" };
              if (alias[name]) name = alias[name];
              const label = name.startsWith("phase:") ? name : `phase:${name}`;
              if (!validPhases.has(label)) {
                await comment(`Unknown phase: ${label}`);
                return;
              }
              const curr = currentPhase(issue);
              await setPhase(issue, label);
              await comment(`ğŸ§­ Phase set: ${curr || "none"} â†’ ${label}\n\n${guidance(label)}`);
              return;
            }
